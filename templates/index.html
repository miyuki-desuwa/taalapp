<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Scraper App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px 0;
        }
        .card {
            width: 100%;
            max-width: 900px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .result-card {
            margin-top: 20px;
        }
        .btn-primary {
            white-space: nowrap;
        }
        .link-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            word-break: break-all;
            transition: background-color 0.2s;
        }
        .link-item:hover {
            background-color: #f8f9fa;
        }
        .link-item:last-child {
            border-bottom: none;
        }
        .external-badge {
            font-size: 0.7em;
            vertical-align: middle;
            margin-left: 8px;
        }
        .link-text {
            color: #333;
            font-weight: 500;
            margin-bottom: 4px;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link-url {
            color: #0a58ca;
            font-size: 0.85em;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link-url:hover {
            text-decoration: underline;
        }
        .no-links {
            color: #6c757d;
            text-align: center;
            padding: 30px 0;
        }
        .copy-btn {
            opacity: 0;
            transition: opacity 0.2s;
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 0.7em;
        }
        .link-item:hover .copy-btn {
            opacity: 1;
        }
        @media (max-width: 768px) {
            .btn-primary {
                width: 100%;
                margin-top: 10px;
            }
            .input-group {
                flex-direction: column;
            }
            .input-group > .form-control {
                border-radius: 0.375rem !important;
            }
            .input-group > .btn {
                border-radius: 0.375rem !important;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">Web Scraper - Extract Links</h3>
                <div class="input-group">
                    <input 
                        type="url" 
                        class="form-control" 
                        id="urlInput" 
                        placeholder="Enter URL to scrape (e.g., https://example.com)" 
                        required
                        autocomplete="off"
                    >
                    <button class="btn btn-primary" type="button" onclick="scrape()">
                        <i class="bi bi-link-45deg"></i> Extract Links
                    </button>
                </div>
                
                <!-- Add bulk scraping button -->
                <div class="mt-3 text-center">
                    <button class="btn btn-warning btn-lg" type="button" onclick="bulkScrape()">
                        <i class="bi bi-database"></i> Start Bulk Scraping (Taal Volcano Data)
                    </button>
                    <div class="mt-2">
                        <small class="text-muted">This will scrape all Taal Volcano bulletins and save data to CSV</small>
                    </div>
                </div>
                
                <div id="result" class="mt-4 d-none">
                    <div class="card result-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Extracted Links</h5>
                            <span id="resultCount" class="badge bg-primary rounded-pill">0 links</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="resultContent" class="list-group list-group-flush">
                                <!-- Links will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Icons and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        async function scrape() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                showError('Please enter a URL');
                urlInput.focus();
                return;
            }

            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                showError('Please enter a valid URL (e.g., https://example.com)');
                urlInput.focus();
                return;
            }

            // Show loading state
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Extracting links from: <br><small>${url}</small></p>
                </div>`;
            resultDiv.classList.remove('d-none');

            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url }),
                });

                const data = await response.json();
                
                if (data.success) {
                    displayResults(data.data);
                } else {
                    showError(data.error || 'An error occurred while scraping');
                }
            } catch (error) {
                showError('Failed to connect to the server. ' + (error.message || 'Please try again later.'));
                console.error('Scraping error:', error);
            }
        }

        function displayResults(data) {
            const resultContent = document.getElementById('resultContent');
            const resultCount = document.getElementById('resultCount');
            
            // Update result count
            resultCount.textContent = `${data.total_links} link${data.total_links !== 1 ? 's' : ''}`;
            
            if (!data.links || data.links.length === 0) {
                resultContent.innerHTML = '<div class="no-links">No links found on this page.</div>';
                return;
            }
            
            // Clear loading state
            resultContent.innerHTML = '';
            
            // Display volcanic data from main page if available
            if (data.volcanic_data) {
                const volcanicData = data.volcanic_data;
                const volcanicDataElement = document.createElement('div');
                volcanicDataElement.className = 'card mb-3';
                
                let volcanicHtml = `
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Volcanic Activity Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                `;
                
                // Add Alert Level if available
                if (volcanicData.alert_level) {
                    volcanicHtml += `
                        <div class="col-md-4 mb-2">
                            <div class="card bg-${getAlertLevelColor(volcanicData.alert_level)} text-white">
                                <div class="card-body p-2 text-center">
                                    <h5 class="card-title mb-0">Alert Level</h5>
                                    <p class="display-4 mb-0">${volcanicData.alert_level}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Add Volcanic Earthquakes if available
                if (volcanicData.volcanic_earthquakes) {
                    volcanicHtml += `
                        <div class="col-md-4 mb-2">
                            <div class="card border-info">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title">Volcanic Earthquakes</h6>
                                    <p class="h4 mb-0">${volcanicData.volcanic_earthquakes}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Add Gas Emissions if available
                if (volcanicData.gas_emissions) {
                    volcanicHtml += `
                        <div class="col-md-4 mb-2">
                            <div class="card border-warning">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title">Gas Emissions</h6>
                                    <p class="h4 mb-0">${volcanicData.gas_emissions}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                volcanicHtml += `</div>`; // Close row
                
                // Add Observations if available
                if (volcanicData.observations && volcanicData.observations.length > 0) {
                    volcanicHtml += `
                        <div class="mt-3">
                            <h6>Key Observations:</h6>
                            <ul class="list-group">
                    `;
                    
                    if (Array.isArray(volcanicData.observations)) {
                        volcanicData.observations.forEach(obs => {
                            volcanicHtml += `<li class="list-group-item">${obs}</li>`;
                        });
                    } else {
                        volcanicHtml += `<li class="list-group-item">${volcanicData.observations}</li>`;
                    }
                    
                    volcanicHtml += `
                            </ul>
                        </div>
                    `;
                }
                
                volcanicHtml += `</div>`; // Close card-body
                volcanicDataElement.innerHTML = volcanicHtml;
                
                // Insert volcanic data before the links list
                resultContent.appendChild(volcanicDataElement);
            }
            
            // Add filter controls
            const filterControls = document.createElement('div');
            filterControls.className = 'p-3 border-bottom d-flex justify-content-between align-items-center';
            filterControls.innerHTML = `
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="showExternal" checked>
                    <label class="form-check-label" for="showExternal">Show external links</label>
                </div>
                <div class="text-muted small">
                    <span id="visibleCount">${data.links.length}</span> of ${data.links.length} links
                </div>
            `;
            resultContent.appendChild(filterControls);
            
            // Create list container
            const listContainer = document.createElement('div');
            listContainer.id = 'linksList';
            
            // Add each link to the results
            data.links.forEach((link, index) => {
                const linkElement = document.createElement('div');
                linkElement.className = `list-group-item list-group-item-action link-item ${link.is_external ? 'external-link' : ''}`;
                linkElement.dataset.external = link.is_external;
                
                // Truncate long URLs for display
                const displayUrl = link.url.length > 80 
                    ? link.url.substring(0, 80) + '...' 
                    : link.url;
                
                // Format date if available
                const dateDisplay = link.date ? 
                    `<div class="text-muted small mt-1">
                        <i class="bi bi-calendar3"></i> ${link.date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}
                    </div>` : '';

                linkElement.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <span class="link-text">
                            ${link.text || '[No text]'}
                            ${link.is_external ? '<span class="badge bg-danger external-badge">External</span>' : ''}
                        </span>
                        <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('${link.url.replace(/'/g, "\\'")}', this)" 
                                title="Copy URL">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    ${dateDisplay}
                    <a href="${link.url}" class="link-url" target="_blank">${displayUrl}</a>
                    <div class="d-flex mt-2">
                        <a href="#" class="btn btn-sm btn-outline-primary download-json" data-url="${link.url}" title="Download JSON data for ${link.url}">
                            <i class="bi bi-file-earmark-code"></i> Download JSON
                        </a>
                        <a href="#" class="btn btn-sm btn-outline-success ms-2 download-html" data-url="${link.url}" title="Download HTML report for ${link.url}">
                            <i class="bi bi-file-earmark-text"></i> Download HTML
                        </a>
                        <button class="btn btn-sm btn-outline-info ms-2" onclick="deepScrape('${link.url.replace(/'/g, "\\'")}')"
                                title="Deep scrape for iframe content">
                            <i class="bi bi-search"></i> Deep Scrape
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(linkElement);
            });
            
            resultContent.appendChild(listContainer);
            
            // Add filter functionality
            document.getElementById('showExternal').addEventListener('change', filterLinks);
            
            // Initial filter
            filterLinks();
            
            // Add click handlers for JSON download
            document.querySelectorAll('.download-json').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.getAttribute('data-url');
                    downloadJsonData(url);
                });
            });
            
            // Add click handlers for HTML download
            document.querySelectorAll('.download-html').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.getAttribute('data-url');
                    downloadHtmlData(url);
                });
            });
        }
        
        function filterLinks() {
            const showExternal = document.getElementById('showExternal').checked;
            const links = document.querySelectorAll('#linksList .link-item');
            let visibleCount = 0;
            
            links.forEach(link => {
                const isExternal = link.dataset.external === 'true';
                if (showExternal || !isExternal) {
                    link.style.display = '';
                    visibleCount++;
                } else {
                    link.style.display = 'none';
                }
            });
            
            document.getElementById('visibleCount').textContent = visibleCount;
        }
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                // Change button appearance temporarily
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i>';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy URL to clipboard');
            });
        }
        
        function showError(message) {
            document.getElementById('resultContent').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                </div>`;
        }
        
        async function downloadJsonData(url) {
            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Create a blob from the JSON data
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create a temporary link and trigger download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `scraped_data_${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showError(data.error || 'Failed to fetch data for download');
                }
            } catch (error) {
                showError('Failed to download data: ' + (error.message || 'Unknown error'));
                console.error('Download error:', error);
            }
        }
        
        async function downloadHtmlData(url) {
            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Generate HTML report
                    const htmlContent = generateHtmlReport(data.data, url);
                    
                    // Create a blob from the HTML data
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const downloadUrl = window.URL.createObjectURL(blob);
                    
                    // Create a temporary link and trigger download
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `scraped_report_${Date.now()}.html`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);
                } else {
                    showError(data.error || 'Failed to fetch data for download');
                }
            } catch (error) {
                showError('Failed to download HTML report: ' + (error.message || 'Unknown error'));
                console.error('Download error:', error);
            }
        }
        
        function generateHtmlReport(data, url) {
            let html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraping Report - ${new URL(url).hostname}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .report-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .link-item { border-left: 4px solid #007bff; }
        .external-link { border-left-color: #dc3545; }
        .volcanic-data { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="card shadow">
                    <div class="card-header report-header text-center py-4">
                        <h1 class="display-6 mb-2"><i class="bi bi-file-earmark-text"></i> Web Scraping Report</h1>
                        <p class="lead mb-0">Generated on ${new Date().toLocaleString()}</p>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h5><i class="bi bi-link-45deg"></i> Source URL</h5>
                                <p class="text-break"><a href="${url}" target="_blank">${url}</a></p>
                            </div>
                            <div class="col-md-4">
                                <h5><i class="bi bi-bar-chart"></i> Summary</h5>
                                <p><strong>Total Links:</strong> ${data.total_links || 0}</p>
                                <p><strong>External Links:</strong> ${data.links ? data.links.filter(link => link.is_external).length : 0}</p>
                                <p><strong>Internal Links:</strong> ${data.links ? data.links.filter(link => !link.is_external).length : 0}</p>
                            </div>
                        </div>
            `;
            
            // Add volcanic data if available
            if (data.volcanic_data) {
                const volcanicData = data.volcanic_data;
                html += `
                        <div class="card mb-4 volcanic-data text-white">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Volcanic Activity Data</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                `;
                
                if (volcanicData.alert_level) {
                    html += `
                                    <div class="col-md-4 mb-3">
                                        <div class="text-center">
                                            <h2 class="display-4">${volcanicData.alert_level}</h2>
                                            <p class="h5">Alert Level</p>
                                        </div>
                                    </div>
                    `;
                }
                
                if (volcanicData.volcanic_earthquakes) {
                    html += `
                                    <div class="col-md-4 mb-3">
                                        <div class="text-center">
                                            <h3>${volcanicData.volcanic_earthquakes}</h3>
                                            <p>Volcanic Earthquakes</p>
                                        </div>
                                    </div>
                    `;
                }
                
                if (volcanicData.gas_emissions) {
                    html += `
                                    <div class="col-md-4 mb-3">
                                        <div class="text-center">
                                            <h3>${volcanicData.gas_emissions}</h3>
                                            <p>Gas Emissions</p>
                                        </div>
                                    </div>
                    `;
                }
                
                html += `</div>`;
                
                if (volcanicData.observations && volcanicData.observations.length > 0) {
                    html += `
                                <div class="mt-3">
                                    <h5>Key Observations:</h5>
                                    <ul>
                    `;
                    
                    if (Array.isArray(volcanicData.observations)) {
                        volcanicData.observations.forEach(obs => {
                            html += `<li>${obs}</li>`;
                        });
                    } else {
                        html += `<li>${volcanicData.observations}</li>`;
                    }
                    
                    html += `</ul></div>`;
                }
                
                html += `
                            </div>
                        </div>
                `;
            }
            
            // Add links section
            html += `
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="bi bi-list-ul"></i> Extracted Links</h4>
                            </div>
                            <div class="card-body p-0">
            `;
            
            if (data.links && data.links.length > 0) {
                data.links.forEach((link, index) => {
                    const linkClass = link.is_external ? 'external-link' : '';
                    const badge = link.is_external ? '<span class="badge bg-danger ms-2">External</span>' : '<span class="badge bg-success ms-2">Internal</span>';
                    
                    html += `
                                <div class="p-3 border-bottom link-item ${linkClass}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">${link.text || '[No text]'} ${badge}</h6>
                                            <a href="${link.url}" class="text-decoration-none small text-muted" target="_blank">${link.url}</a>
                    `;
                    
                    if (link.date) {
                        html += `
                                            <div class="text-muted small mt-1">
                                                <i class="bi bi-calendar3"></i> ${new Date(link.date).toLocaleDateString('en-US', { 
                                                    year: 'numeric', 
                                                    month: 'long', 
                                                    day: 'numeric' 
                                                })}
                                            </div>
                        `;
                    }
                    
                    html += `
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-light text-dark">#${index + 1}</span>
                                        </div>
                                    </div>
                                </div>
                    `;
                });
            } else {
                html += `
                                <div class="text-center p-5 text-muted">
                                    <i class="bi bi-inbox display-1"></i>
                                    <p class="mt-3">No links found on this page.</p>
                                </div>
                `;
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-center text-muted">
                        <small>Report generated by Web Scraper App on ${new Date().toLocaleString()}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
            `;
            
            return html;
         }
         
         function generateDeepScrapeHtmlReport(data, iframeSrc) {
             let html = `
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Deep Scrape Report - ${new URL(iframeSrc || data.url).hostname}</title>
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
     <style>
         body { background-color: #f8f9fa; }
         .report-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
         .iframe-section { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
         .volcanic-data { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
         .image-gallery img { max-height: 200px; object-fit: cover; }
     </style>
 </head>
 <body>
     <div class="container-fluid py-4">
         <div class="row justify-content-center">
             <div class="col-12 col-lg-10">
                 <div class="card shadow">
                     <div class="card-header report-header text-center py-4">
                         <h1 class="display-6 mb-2"><i class="bi bi-search"></i> Deep Scrape Report</h1>
                         <p class="lead mb-0">Generated on ${new Date().toLocaleString()}</p>
                     </div>
                     <div class="card-body">
                         <div class="row mb-4">
                             <div class="col-12">
                                 <h5><i class="bi bi-link-45deg"></i> Source Information</h5>
                                 <p><strong>Original URL:</strong> <a href="${data.url}" target="_blank">${data.url}</a></p>
                                 ${iframeSrc ? `<p><strong>Iframe Source:</strong> <a href="${iframeSrc}" target="_blank">${iframeSrc}</a></p>` : ''}
                             </div>
                         </div>
             `;
             
             // Add iframe content if available
             if (data.iframe_content) {
                 const iframeContent = data.iframe_content;
                 
                 html += `
                         <div class="card mb-4 iframe-section text-white">
                             <div class="card-header">
                                 <h4 class="mb-0"><i class="bi bi-window"></i> Iframe Content Analysis</h4>
                             </div>
                             <div class="card-body">
                 `;
                 
                 // Add images if available
                 if (iframeContent.images && iframeContent.images.length > 0) {
                     html += `
                                 <div class="mb-4">
                                     <h5><i class="bi bi-images"></i> Images Found (${iframeContent.images.length})</h5>
                                     <div class="row image-gallery">
                     `;
                     
                     iframeContent.images.forEach((imgSrc, index) => {
                         html += `
                                         <div class="col-md-4 col-lg-3 mb-3">
                                             <div class="card">
                                                 <img src="${imgSrc}" class="card-img-top" alt="Image ${index + 1}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150x100?text=Image+Error';">
                                                 <div class="card-body p-2">
                                                     <small class="text-muted text-break">${imgSrc}</small>
                                                 </div>
                                             </div>
                                         </div>
                         `;
                     });
                     
                     html += `
                                     </div>
                                 </div>
                     `;
                 }
                 
                 html += `
                             </div>
                         </div>
                 `;
                 
                 // Add volcanic data from iframe if available
                 if (iframeContent.volcanic_data) {
                     const volcanicData = iframeContent.volcanic_data;
                     html += `
                         <div class="card mb-4 volcanic-data text-white">
                             <div class="card-header">
                                 <h4 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Volcanic Activity Data (from Iframe)</h4>
                             </div>
                             <div class="card-body">
                                 <div class="row">
                     `;
                     
                     if (volcanicData.alert_level) {
                         html += `
                                     <div class="col-md-4 mb-3">
                                         <div class="text-center">
                                             <h2 class="display-4">${volcanicData.alert_level}</h2>
                                             <p class="h5">Alert Level</p>
                                         </div>
                                     </div>
                         `;
                     }
                     
                     if (volcanicData.volcanic_earthquakes) {
                         html += `
                                     <div class="col-md-4 mb-3">
                                         <div class="text-center">
                                             <h3>${volcanicData.volcanic_earthquakes}</h3>
                                             <p>Volcanic Earthquakes</p>
                                         </div>
                                     </div>
                         `;
                     }
                     
                     if (volcanicData.gas_emissions) {
                         html += `
                                     <div class="col-md-4 mb-3">
                                         <div class="text-center">
                                             <h3>${volcanicData.gas_emissions}</h3>
                                             <p>Gas Emissions</p>
                                         </div>
                                     </div>
                         `;
                     }
                     
                     html += `</div>`;
                     
                     // Add additional volcanic data
                     if (volcanicData.plume_activity || volcanicData.ground_deformation || volcanicData.seismic_activity) {
                         html += `
                                 <div class="row mt-3">
                         `;
                         
                         if (volcanicData.plume_activity) {
                             html += `
                                     <div class="col-md-6 mb-3">
                                         <div class="card bg-light text-dark">
                                             <div class="card-header">Plume Activity</div>
                                             <div class="card-body">
                                                 <p class="card-text">${volcanicData.plume_activity}</p>
                                             </div>
                                         </div>
                                     </div>
                             `;
                         }
                         
                         if (volcanicData.ground_deformation) {
                             html += `
                                     <div class="col-md-6 mb-3">
                                         <div class="card bg-light text-dark">
                                             <div class="card-header">Ground Deformation</div>
                                             <div class="card-body">
                                                 <p class="card-text">${volcanicData.ground_deformation}</p>
                                             </div>
                                         </div>
                                     </div>
                             `;
                         }
                         
                         if (volcanicData.seismic_activity) {
                             html += `
                                     <div class="col-12 mb-3">
                                         <div class="card bg-light text-dark">
                                             <div class="card-header">Seismic Activity</div>
                                             <div class="card-body">
                                                 <p class="card-text">${volcanicData.seismic_activity}</p>
                                             </div>
                                         </div>
                                     </div>
                             `;
                         }
                         
                         html += `</div>`;
                     }
                     
                     if (volcanicData.observations) {
                         html += `
                                 <div class="mt-3">
                                     <h5>Key Observations:</h5>
                                     <ul class="list-unstyled">
                         `;
                         
                         if (Array.isArray(volcanicData.observations)) {
                             volcanicData.observations.forEach(obs => {
                                 html += `<li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> ${obs}</li>`;
                             });
                         } else {
                             html += `<li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> ${volcanicData.observations}</li>`;
                         }
                         
                         html += `</ul></div>`;
                     }
                     
                     html += `
                             </div>
                         </div>
                     `;
                 }
                 
                 // Add text content if available
                 if (iframeContent.text) {
                     html += `
                         <div class="card mb-4">
                             <div class="card-header">
                                 <h4 class="mb-0"><i class="bi bi-file-text"></i> Extracted Text Content</h4>
                             </div>
                             <div class="card-body">
                                 <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">${iframeContent.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                             </div>
                         </div>
                     `;
                 }
             }
             
             // Add main page volcanic data if available
             if (data.main_page_volcanic_data) {
                 const volcanicData = data.main_page_volcanic_data;
                 html += `
                         <div class="card mb-4 volcanic-data text-white">
                             <div class="card-header">
                                 <h4 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Volcanic Activity Data (from Main Page)</h4>
                             </div>
                             <div class="card-body">
                                 <div class="row">
                 `;
                 
                 if (volcanicData.alert_level) {
                     html += `
                                     <div class="col-md-4 mb-3">
                                         <div class="text-center">
                                             <h2 class="display-4">${volcanicData.alert_level}</h2>
                                             <p class="h5">Alert Level</p>
                                         </div>
                                     </div>
                     `;
                 }
                 
                 if (volcanicData.volcanic_earthquakes) {
                     html += `
                                     <div class="col-md-4 mb-3">
                                         <div class="text-center">
                                             <h3>${volcanicData.volcanic_earthquakes}</h3>
                                             <p>Volcanic Earthquakes</p>
                                         </div>
                                     </div>
                     `;
                 }
                 
                 if (volcanicData.gas_emissions) {
                     html += `
                                     <div class="col-md-4 mb-3">
                                         <div class="text-center">
                                             <h3>${volcanicData.gas_emissions}</h3>
                                             <p>Gas Emissions</p>
                                         </div>
                                     </div>
                     `;
                 }
                 
                 html += `</div>`;
                 
                 if (volcanicData.observations) {
                     html += `
                                 <div class="mt-3">
                                     <h5>Key Observations:</h5>
                                     <ul class="list-unstyled">
                     `;
                     
                     if (Array.isArray(volcanicData.observations)) {
                         volcanicData.observations.forEach(obs => {
                             html += `<li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> ${obs}</li>`;
                         });
                     } else {
                         html += `<li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> ${volcanicData.observations}</li>`;
                     }
                     
                     html += `</ul></div>`;
                 }
                 
                 html += `
                             </div>
                         </div>
                 `;
             }
             
             // Add raw JSON data section
             html += `
                         <div class="card mb-4">
                             <div class="card-header">
                                 <h4 class="mb-0"><i class="bi bi-code-square"></i> Raw JSON Data</h4>
                             </div>
                             <div class="card-body">
                                 <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                             </div>
                         </div>
                     </div>
                     <div class="card-footer text-center text-muted">
                         <small>Deep Scrape Report generated by Web Scraper App on ${new Date().toLocaleString()}</small>
                     </div>
                 </div>
             </div>
         </div>
     </div>
 </body>
 </html>
             `;
             
             return html;
         }
         
         async function deepScrape(url) {
            try {
                // Show loading modal
                const modal = showDeepScrapeLoading(url);
                
                // Create a hidden iframe to first visit the page
                const iframeContainer = document.createElement('div');
                iframeContainer.style.display = 'none';
                document.body.appendChild(iframeContainer);
                
                // Update loading message
                document.getElementById('deepScrapeContent').innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Step 1/2: Loading page in background: <br><small>${url}</small></p>
                        <div class="progress mt-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 50%"></div>
                        </div>
                    </div>
                `;
                
                // Create a promise that resolves when the iframe loads or after timeout
                const preloadPromise = new Promise((resolve) => {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '1px';
                    iframe.style.height = '1px';
                    iframe.style.opacity = '0.01';
                    iframe.style.position = 'absolute';
                    iframe.style.zIndex = '-1000';
                    
                    // Always wait for 10 seconds to ensure the page fully loads
                     // and any dynamic content has time to render
                     iframe.onload = () => {
                         // Update loading message to show countdown
                         const startTime = Date.now();
                         const totalWaitTime = 10000; // 10 seconds
                         
                         const updateCountdown = () => {
                             const elapsedTime = Date.now() - startTime;
                             const remainingTime = Math.max(0, totalWaitTime - elapsedTime);
                             const remainingSeconds = Math.ceil(remainingTime / 1000);
                             const progressPercent = Math.min(100, (elapsedTime / totalWaitTime) * 100);
                             
                             document.getElementById('deepScrapeContent').innerHTML = `
                                 <div class="text-center p-5">
                                     <div class="spinner-border text-primary" role="status">
                                         <span class="visually-hidden">Loading...</span>
                                     </div>
                                     <p class="mt-3 text-muted">Step 1/2: Running page in background: <br><small>${url}</small></p>
                                     <p class="text-muted">Waiting ${remainingSeconds} more seconds for page to fully load...</p>
                                     <div class="progress mt-3">
                                         <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                              role="progressbar" style="width: ${progressPercent}%"></div>
                                     </div>
                                 </div>
                             `;
                             
                             if (remainingTime > 0) {
                                 setTimeout(updateCountdown, 1000);
                             } else {
                                 resolve();
                             }
                         };
                         
                         updateCountdown();
                     };
                     
                     // Set a timeout in case the iframe fails to load
                     const timeoutId = setTimeout(() => {
                         // If iframe fails to load, still wait 10 seconds
                         setTimeout(resolve, 10000);
                     }, 5000); // 5 second timeout for initial load attempt
                    
                    iframe.onerror = () => {
                         clearTimeout(timeoutId);
                         // Even on error, wait 10 seconds to allow for any content to load
                         // Update loading message to show countdown
                         const startTime = Date.now();
                         const totalWaitTime = 10000; // 10 seconds
                         
                         const updateCountdown = () => {
                             const elapsedTime = Date.now() - startTime;
                             const remainingTime = Math.max(0, totalWaitTime - elapsedTime);
                             const remainingSeconds = Math.ceil(remainingTime / 1000);
                             const progressPercent = Math.min(100, (elapsedTime / totalWaitTime) * 100);
                             
                             document.getElementById('deepScrapeContent').innerHTML = `
                                 <div class="text-center p-5">
                                     <div class="spinner-border text-primary" role="status">
                                         <span class="visually-hidden">Loading...</span>
                                     </div>
                                     <p class="mt-3 text-muted">Step 1/2: Running page in background: <br><small>${url}</small></p>
                                     <p class="text-muted">Waiting ${remainingSeconds} more seconds for page to fully load...</p>
                                     <div class="progress mt-3">
                                         <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                              role="progressbar" style="width: ${progressPercent}%"></div>
                                     </div>
                                 </div>
                             `;
                             
                             if (remainingTime > 0) {
                                 setTimeout(updateCountdown, 1000);
                             } else {
                                 resolve();
                             }
                         };
                         
                         updateCountdown();
                     };
                    
                    iframe.src = url;
                    iframeContainer.appendChild(iframe);
                });
                
                // Wait for the iframe to load
                await preloadPromise;
                
                // Update loading message for step 2
                document.getElementById('deepScrapeContent').innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Step 2/2: Deep scraping content from: <br><small>${url}</small></p>
                        <p class="text-muted small">Searching for iframe in div with class="sppb-addon-content"...</p>
                        <div class="progress mt-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 90%"></div>
                        </div>
                    </div>
                `;
                
                // Now perform the actual deep scrape
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        url: url,
                        deep_scrape: true 
                    }),
                });
                
                // Clean up the iframe
                document.body.removeChild(iframeContainer);
                
                const data = await response.json();
                
                if (data.success) {
                    displayDeepScrapeResults(data.data);
                } else {
                    showDeepScrapeError(data.error || 'Failed to perform deep scrape');
                }
            } catch (error) {
                showDeepScrapeError('Failed to perform deep scrape: ' + (error.message || 'Unknown error'));
                console.error('Deep scrape error:', error);
            }
        }
        
        function showDeepScrapeLoading(url) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('deepScrapeModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'deepScrapeModal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-hidden', 'true');
                
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Deep Scrape Results</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="deepScrapeContent">
                                <!-- Content will be inserted here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="downloadDeepScrapeBtn">
                                    <i class="bi bi-download"></i> Download JSON
                                </button>
                                <button type="button" class="btn btn-success ms-2" id="downloadDeepScrapeHtmlBtn">
                                    <i class="bi bi-file-earmark-code"></i> Download HTML
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // Show loading state
            document.getElementById('deepScrapeContent').innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Deep scraping content from: <br><small>${url}</small></p>
                    <p class="text-muted small">Searching for iframe in div with class="sppb-addon-content"...</p>
                </div>
            `;
            
            // Initialize and show the modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            return bsModal;
        }
        
        function displayDeepScrapeResults(data) {
            const contentDiv = document.getElementById('deepScrapeContent');
            
            // Store the full data for download
            contentDiv.dataset.fullData = JSON.stringify(data);
            
            if (!data.iframe_content) {
                contentDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        No iframe found in div with class="sppb-addon-content" on this page.
                    </div>
                `;
                return;
            }
            
            if (data.iframe_content.error) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        ${data.iframe_content.error}
                    </div>
                `;
                return;
            }
            
            // Build the content display
            let html = `
                <div class="mb-3">
                    <h6>Iframe Source:</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" value="${data.iframe_src}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('${data.iframe_src.replace(/'/g, "\\'")}', this)">Copy</button>
                    </div>
                </div>
            `;
            
            // Display images if available
            if (data.iframe_content.images && data.iframe_content.images.length > 0) {
                html += `<h6>Images (${data.iframe_content.images.length}):</h6><div class="row">`;
                
                data.iframe_content.images.forEach(imgSrc => {
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <img src="${imgSrc}" class="card-img-top" alt="Image" onerror="this.onerror=null;this.src='https://via.placeholder.com/150x100?text=Image+Error';">
                                <div class="card-body p-2">
                                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="copyToClipboard('${imgSrc.replace(/'/g, "\\'")}')">Copy URL</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Display volcanic data if available
            if (data.iframe_content.volcanic_data) {
                const volcanicData = data.iframe_content.volcanic_data;
                html += `
                    <div class="mt-3">
                        <h6>Volcanic Activity Data:</h6>
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    ${volcanicData.alert_level ? `
                                    <div class="col-md-4 mb-2">
                                        <div class="card bg-${getAlertLevelColor(volcanicData.alert_level)} text-white">
                                            <div class="card-body p-2 text-center">
                                                <h5 class="card-title mb-0">Alert Level</h5>
                                                <p class="display-4 mb-0">${volcanicData.alert_level}</p>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                    
                                    ${volcanicData.volcanic_earthquakes ? `
                                    <div class="col-md-4 mb-2">
                                        <div class="card border-info">
                                            <div class="card-body p-2 text-center">
                                                <h6 class="card-title">Volcanic Earthquakes</h6>
                                                <p class="h4 mb-0">${volcanicData.volcanic_earthquakes}</p>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                    
                                    ${volcanicData.gas_emissions ? `
                                    <div class="col-md-4 mb-2">
                                        <div class="card border-warning">
                                            <div class="card-body p-2 text-center">
                                                <h6 class="card-title">Gas Emissions</h6>
                                                <p class="h4 mb-0">${volcanicData.gas_emissions}</p>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                </div>
                                
                                <div class="row mt-2">
                                    ${volcanicData.plume_activity ? `
                                    <div class="col-md-6 mb-2">
                                        <div class="card border-secondary">
                                            <div class="card-header py-1 px-3">Plume Activity</div>
                                            <div class="card-body py-2 px-3">
                                                <p class="card-text mb-0">${volcanicData.plume_activity}</p>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                    
                                    ${volcanicData.ground_deformation ? `
                                    <div class="col-md-6 mb-2">
                                        <div class="card border-secondary">
                                            <div class="card-header py-1 px-3">Ground Deformation</div>
                                            <div class="card-body py-2 px-3">
                                                <p class="card-text mb-0">${volcanicData.ground_deformation}</p>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                </div>
                                
                                <div class="row mt-2">
                                    ${volcanicData.seismic_activity ? `
                                    <div class="col-12 mb-2">
                                        <div class="card border-secondary">
                                            <div class="card-header py-1 px-3">Seismic Activity</div>
                                            <div class="card-body py-2 px-3">
                                                <p class="card-text mb-0">${volcanicData.seismic_activity}</p>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                </div>
                                
                                ${volcanicData.observations && volcanicData.observations.length > 0 ? `
                                <div class="mt-2">
                                    <h6>Key Observations:</h6>
                                    <ul class="list-group">
                                        ${Array.isArray(volcanicData.observations) ? 
                                          volcanicData.observations.map(obs => `<li class="list-group-item">${obs}</li>`).join('') : 
                                          `<li class="list-group-item">${volcanicData.observations}</li>`}
                                    </ul>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Display text content
            if (data.iframe_content.text) {
                html += `
                    <div class="mt-3">
                        <h6>Text Content:</h6>
                        <div class="border p-3 bg-light">
                            <pre class="mb-0" style="white-space: pre-wrap;">${data.iframe_content.text}</pre>
                        </div>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = html;
            
            // Set up download buttons
            document.getElementById('downloadDeepScrapeBtn').onclick = function() {
                const blob = new Blob([contentDiv.dataset.fullData], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `deep_scrape_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            };
            
            document.getElementById('downloadDeepScrapeHtmlBtn').onclick = function() {
                const fullData = JSON.parse(contentDiv.dataset.fullData);
                const htmlContent = generateDeepScrapeHtmlReport(fullData, data.iframe_src);
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `deep_scrape_report_${Date.now()}.html`;
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            };
        }
        
        function showDeepScrapeError(message) {
            const contentDiv = document.getElementById('deepScrapeContent');
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        // Allow form submission with Enter key
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                scrape();
            }
        });
        
        // Focus the input field on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('urlInput');
            if (urlInput) {
                urlInput.focus();
            }
        });
        
        // Helper function to determine alert level color
        function getAlertLevelColor(level) {
            level = parseInt(level);
            switch(level) {
                case 0:
                    return 'success'; // Green
                case 1:
                    return 'info';    // Blue
                case 2:
                    return 'warning'; // Yellow
                case 3:
                    return 'orange';  // Orange
                case 4:
                case 5:
                    return 'danger';  // Red
                default:
                    return 'secondary'; // Gray
            }
        }
        
        async function bulkScrape() {
            if (!confirm('This will start bulk scraping of Taal Volcano data. This process may take a long time. Continue?')) {
                return;
            }
            
            // Show loading state
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Bulk scraping in progress...<br><small>This may take several minutes</small></p>
                </div>`;
            resultDiv.classList.remove('d-none');
            
            try {
                const response = await fetch('/bulk_scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultContent.innerHTML = `
                        <div class="alert alert-success" role="alert">
                            <h4 class="alert-heading">Bulk Scraping Completed!</h4>
                            <p>${data.message}</p>
                            <hr>
                            <p class="mb-0">CSV file: <strong>${data.csv_filename}</strong></p>
                            <p class="mb-0">Pages processed: <strong>${data.total_pages_processed}</strong></p>
                            <p class="mb-0">Data entries saved: <strong>${data.total_data_entries}</strong></p>
                        </div>`;
                } else {
                    showError(data.error || 'Bulk scraping failed');
                }
            } catch (error) {
                showError('Failed to start bulk scraping: ' + (error.message || 'Unknown error'));
                console.error('Bulk scraping error:', error);
            }
        }
        
        function showBulkScrapeLoading() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('bulkScrapeModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'bulkScrapeModal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-hidden', 'true');
                
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Bulk Scraping Results</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="bulkScrapeContent">
                                <!-- Content will be inserted here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" id="downloadBulkCsvBtn">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // Show loading state
            document.getElementById('bulkScrapeContent').innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Bulk scraping Taal Volcano data...</p>
                    <p class="text-muted small">This may take several minutes as we scrape all bulletin pages.</p>
                </div>
            `;
            
            // Initialize and show the modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            return bsModal;
        }
        
        function displayBulkScrapeResults(data) {
            const contentDiv = document.getElementById('bulkScrapeContent');
            
            if (!data.csv_file) {
                contentDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        No CSV file was generated.
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    Bulk scraping completed successfully!
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Records</h5>
                                <h2 class="text-primary">${data.total_records || 0}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">CSV File</h5>
                                <p class="text-success"><i class="bi bi-file-earmark-spreadsheet"></i> Ready for download</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.sample_data && data.sample_data.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Sample Data (First 5 records)</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Alert Level</th>
                                            <th>Volcanic Earthquakes</th>
                                            <th>Gas Emissions</th>
                                            <th>Observations</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.sample_data.slice(0, 5).forEach(record => {
                    html += `
                        <tr>
                            <td>${record.date || 'N/A'}</td>
                            <td><span class="badge bg-${getAlertLevelColor(record.alert_level)}">${record.alert_level || 'N/A'}</span></td>
                            <td>${record.volcanic_earthquakes || 'N/A'}</td>
                            <td>${record.gas_emissions || 'N/A'}</td>
                            <td>${record.observations ? (record.observations.length > 100 ? record.observations.substring(0, 100) + '...' : record.observations) : 'N/A'}</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = html;
            
            // Set up download button
            document.getElementById('downloadBulkCsvBtn').onclick = function() {
                window.location.href = `/download_csv/${data.csv_file}`;
            };
        }
        
        function showBulkScrapeError(message) {
            const contentDiv = document.getElementById('bulkScrapeContent');
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                </div>
            `;
        }
    </script>
</body>
</html>
